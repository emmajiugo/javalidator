name: Create Release

on:
  workflow_dispatch:
    inputs:
      version-type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
      custom-version:
        description: 'Custom version (optional, overrides version-type)'
        required: false
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate next version
        id: version
        run: |
          # Get latest git tag as source of truth (not pom.xml)
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          # Remove 'v' prefix to get version number
          CURRENT_VERSION=${LATEST_TAG#v}
          echo "Latest released version (from git tag): $CURRENT_VERSION"

          if [ -n "${{ github.event.inputs.custom-version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.custom-version }}"
            echo "Using custom version: $NEW_VERSION"
          else
            # Split version into components
            IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR="${VERSION_PARTS[0]}"
            MINOR="${VERSION_PARTS[1]}"
            PATCH="${VERSION_PARTS[2]}"

            case "${{ github.event.inputs.version-type }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac

            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            echo "Calculated new version: $NEW_VERSION"
          fi

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update version in pom.xml
        run: |
          ./mvnw versions:set -DnewVersion=${{ steps.version.outputs.version }}
          ./mvnw versions:set-property -Dproperty=revision -DnewVersion=${{ steps.version.outputs.version }}
          # Update javalidator-core dependency version in examples
          ./mvnw versions:use-dep-version -Dincludes=io.github.emmajiugo:javalidator-core -DdepVersion=${{ steps.version.outputs.version }} -DforceVersion=true
          ./mvnw versions:commit

      - name: Run tests
        run: ./mvnw clean install

      - name: Commit version update
        run: |
          git add pom.xml javalidator-core/pom.xml examples/*/pom.xml
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
          git push

      - name: Create and push tag
        run: |
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release version ${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## Changes in version ${{ steps.version.outputs.version }}

            See [CHANGELOG.md](CHANGELOG.md) for details.

            ### Maven
            ```xml
            <dependency>
                <groupId>io.github.emmajiugo</groupId>
                <artifactId>javalidator-core</artifactId>
                <version>${{ steps.version.outputs.version }}</version>
            </dependency>
            ```

            ### Gradle
            ```groovy
            implementation 'io.github.emmajiugo:javalidator-core:${{ steps.version.outputs.version }}'
            ```
          draft: false
          prerelease: false

      - name: Prepare next snapshot version
        run: |
          NEXT_VERSION="${{ steps.version.outputs.version }}"
          IFS='.' read -r -a VERSION_PARTS <<< "$NEXT_VERSION"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"
          PATCH=$((PATCH + 1))
          SNAPSHOT_VERSION="$MAJOR.$MINOR.$PATCH-SNAPSHOT"

          ./mvnw versions:set -DnewVersion=$SNAPSHOT_VERSION
          # Update javalidator-core dependency version in examples
          ./mvnw versions:use-dep-version -Dincludes=io.github.emmajiugo:javalidator-core -DdepVersion=$SNAPSHOT_VERSION -DforceVersion=true
          ./mvnw versions:commit

          git add pom.xml javalidator-core/pom.xml examples/*/pom.xml
          git commit -m "chore: prepare next development iteration $SNAPSHOT_VERSION"
          git push